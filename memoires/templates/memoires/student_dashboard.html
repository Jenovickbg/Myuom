{% extends 'users/base.html' %}
{% load static %}

{% block title %}Mon Mémoire - MyUOM{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" style="color: var(--uom-blue);">
            <i class="bi bi-journal-text"></i> Mon Mémoire de {{ niveau }}
        </h2>
        <a href="{% url 'student_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
    </div>

    {% if memoire %}
        <!-- Progression du mémoire -->
        <div class="card card-uom mb-4">
            <div class="card-body">
                <h5 class="mb-3" style="color: var(--uom-blue);">
                    <i class="bi bi-clipboard-check"></i> État d'avancement
                </h5>
                
                <!-- Timeline de progression -->
                <div class="timeline-progress mb-4">
                    <div class="progress-step {% if memoire.statut in 'soumis valide en_cours termine certifie' %}completed{% elif memoire.statut == 'brouillon' %}active{% endif %}">
                        <div class="step-icon">{% if memoire.statut in 'soumis valide en_cours termine certifie' %}<i class="bi bi-check-circle-fill"></i>{% else %}<span>1</span>{% endif %}</div>
                        <div class="step-label">Sujet soumis</div>
                    </div>
                    <div class="progress-line {% if memoire.statut in 'valide en_cours termine certifie' %}completed{% endif %}"></div>
                    <div class="progress-step {% if memoire.statut in 'valide en_cours termine certifie' %}completed{% elif memoire.statut == 'soumis' %}active{% endif %}">
                        <div class="step-icon">{% if memoire.statut in 'valide en_cours termine certifie' %}<i class="bi bi-check-circle-fill"></i>{% else %}<span>2</span>{% endif %}</div>
                        <div class="step-label">Sujet validé</div>
                    </div>
                    <div class="progress-line {% if memoire.statut in 'termine certifie' %}completed{% endif %}"></div>
                    <div class="progress-step {% if memoire.statut in 'termine certifie' %}completed{% elif memoire.statut in 'valide en_cours' %}active{% endif %}">
                        <div class="step-icon">{% if memoire.statut in 'termine certifie' %}<i class="bi bi-check-circle-fill"></i>{% else %}<span>3</span>{% endif %}</div>
                        <div class="step-label">Mémoire déposé</div>
                    </div>
                    <div class="progress-line {% if memoire.statut == 'certifie' %}completed{% endif %}"></div>
                    <div class="progress-step {% if memoire.statut == 'certifie' %}completed{% elif memoire.statut == 'termine' %}active{% endif %}">
                        <div class="step-icon">{% if memoire.statut == 'certifie' %}<i class="bi bi-check-circle-fill"></i>{% else %}<span>4</span>{% endif %}</div>
                        <div class="step-label">Certifié</div>
                    </div>
                </div>

                <!-- Informations du mémoire -->
                <div class="row">
                    <div class="col-md-8">
                        <h6 style="color: var(--uom-blue);">{{ memoire.titre }}</h6>
                        <p class="text-muted mb-2">{{ memoire.description|truncatewords:30 }}</p>
                        <p class="mb-1"><strong>Domaine:</strong> {{ memoire.get_domaine_display }}</p>
                        
                        {% if memoire.directeur %}
                            <p class="mb-1"><strong>Directeur:</strong> {{ memoire.directeur.get_full_name }}</p>
                        {% endif %}
                        {% if memoire.encadreur %}
                            <p class="mb-1"><strong>Encadreur:</strong> {{ memoire.encadreur.get_full_name }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        {% if memoire.statut == 'brouillon' %}
                            <span class="badge bg-secondary fs-6">Brouillon</span>
                        {% elif memoire.statut == 'soumis' %}
                            <span class="badge bg-info fs-6">En attente de validation</span>
                        {% elif memoire.statut == 'valide' %}
                            <span class="badge bg-success fs-6">Validé</span>
                        {% elif memoire.statut == 'refuse' %}
                            <span class="badge bg-danger fs-6">Refusé</span>
                        {% elif memoire.statut == 'en_cours' %}
                            <span class="badge bg-warning fs-6">En cours</span>
                        {% elif memoire.statut == 'termine' %}
                            <span class="badge bg-primary fs-6">Terminé</span>
                        {% elif memoire.statut == 'certifie' %}
                            <span class="badge bg-success fs-6"><i class="bi bi-award"></i> Certifié</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Messages et commentaires -->
                {% if memoire.commentaire_admin %}
                    <div class="alert alert-info mt-3">
                        <strong><i class="bi bi-info-circle"></i> Commentaire de l'administration:</strong><br>
                        {{ memoire.commentaire_admin }}
                    </div>
                {% endif %}
                
                {% if memoire.motif_refus %}
                    <div class="alert alert-danger mt-3">
                        <strong><i class="bi bi-x-circle"></i> Motif de refus:</strong><br>
                        {{ memoire.motif_refus }}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions disponibles -->
        <div class="row g-3">
            <!-- Action 1: Modifier le sujet -->
            {% if memoire.statut in 'brouillon refuse' %}
                <div class="col-md-6 col-lg-4">
                    <div class="card card-uom h-100 action-card">
                        <div class="card-body text-center">
                            <i class="bi bi-pencil-square" style="font-size: 2.5rem; color: var(--uom-blue);"></i>
                            <h5 class="mt-3 mb-2">Modifier le sujet</h5>
                            <p class="text-muted small">Modifier les informations de votre sujet de mémoire</p>
                            <button class="btn btn-uom-primary" data-bs-toggle="modal" data-bs-target="#modalSoumettreSujet">
                                <i class="bi bi-pencil"></i> Modifier
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Action 2: Voir les détails -->
            <div class="col-md-6 col-lg-4">
                <div class="card card-uom h-100 action-card">
                    <div class="card-body text-center">
                        <i class="bi bi-eye" style="font-size: 2.5rem; color: var(--uom-blue);"></i>
                        <h5 class="mt-3 mb-2">Détails du sujet</h5>
                        <p class="text-muted small">Consulter toutes les informations de votre mémoire</p>
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalDetailsSujet">
                            <i class="bi bi-eye"></i> Voir détails
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action 3: Déposer le mémoire -->
            {% if memoire.peut_deposer_final and memoire.statut != 'certifie' %}
                <div class="col-md-6 col-lg-4">
                    <div class="card card-uom h-100 action-card">
                        <div class="card-body text-center">
                            <i class="bi bi-cloud-upload" style="font-size: 2.5rem; color: var(--uom-blue);"></i>
                            <h5 class="mt-3 mb-2">Déposer le mémoire</h5>
                            <p class="text-muted small">Téléverser votre mémoire final en PDF</p>
                            <button class="btn btn-uom-primary" data-bs-toggle="modal" data-bs-target="#modalDeposerMemoire">
                                <i class="bi bi-upload"></i> Déposer
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Action 4: Vérifier plagiat -->
            {% if memoire.statut == 'termine' and memoire.fichier_memoire and not memoire.plagiat_verifie %}
                <div class="col-md-6 col-lg-4">
                    <div class="card card-uom h-100 action-card">
                        <div class="card-body text-center">
                            <i class="bi bi-shield-check" style="font-size: 2.5rem; color: var(--uom-blue);"></i>
                            <h5 class="mt-3 mb-2">Vérifier plagiat</h5>
                            <p class="text-muted small">Lancer la vérification anti-plagiat</p>
                            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalVerifierPlagiat">
                                <i class="bi bi-shield"></i> Vérifier
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Action 5: Rapport plagiat -->
            {% if memoire.plagiat_verifie %}
                <div class="col-md-6 col-lg-4">
                    <div class="card card-uom h-100 action-card">
                        <div class="card-body text-center">
                            {% if memoire.score_plagiat < 20 %}
                                <i class="bi bi-check-circle" style="font-size: 2.5rem; color: #28a745;"></i>
                            {% else %}
                                <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem; color: #ffc107;"></i>
                            {% endif %}
                            <h5 class="mt-3 mb-2">Rapport anti-plagiat</h5>
                            <p class="text-muted small">Score: {{ memoire.score_plagiat|floatformat:2 }}%</p>
                            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalRapportPlagiat">
                                <i class="bi bi-file-text"></i> Voir rapport
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Action 6: Confirmer et obtenir certificat -->
            {% if memoire.plagiat_verifie and memoire.score_plagiat < 20 and memoire.statut != 'certifie' %}
                <div class="col-md-6 col-lg-4">
                    <div class="card card-uom h-100 action-card">
                        <div class="card-body text-center">
                            <i class="bi bi-award" style="font-size: 2.5rem; color: #ffd700;"></i>
                            <h5 class="mt-3 mb-2">Obtenir certificat</h5>
                            <p class="text-muted small">Confirmer et générer votre certificat de dépôt</p>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalConfirmerFinal">
                                <i class="bi bi-check-circle"></i> Confirmer
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Action 7: Télécharger certificat -->
            {% if memoire.statut == 'certifie' %}
                <div class="col-md-6 col-lg-4">
                    <div class="card card-uom h-100 action-card border-success">
                        <div class="card-body text-center">
                            <i class="bi bi-file-earmark-pdf" style="font-size: 2.5rem; color: #28a745;"></i>
                            <h5 class="mt-3 mb-2 text-success">Certificat disponible</h5>
                            <p class="text-muted small">N° {{ memoire.certificat.numero_certificat }}</p>
                            <a href="{% url 'memoires:student_telecharger_certificat' %}" class="btn btn-success" target="_blank">
                                <i class="bi bi-download"></i> Télécharger
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

    {% else %}
        <!-- Aucun mémoire: Invitation à soumettre -->
        <div class="card card-uom text-center py-5">
            <div class="card-body">
                <i class="bi bi-journal-plus" style="font-size: 5rem; color: var(--uom-blue); opacity: 0.5;"></i>
                <h4 class="mt-4 mb-3" style="color: var(--uom-blue);">Commencez votre mémoire</h4>
                <p class="text-muted mb-4">Soumettez votre sujet de mémoire pour démarrer le processus</p>
                <button class="btn btn-uom-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalSoumettreSujet">
                    <i class="bi bi-plus-circle"></i> Soumettre mon sujet
                </button>
            </div>
        </div>
    {% endif %}
</div>

<!-- MODALES -->
{% include 'memoires/modals/soumettre_sujet.html' %}
{% include 'memoires/modals/details_sujet.html' %}
{% include 'memoires/modals/deposer_memoire.html' %}
{% include 'memoires/modals/verifier_plagiat.html' %}
{% include 'memoires/modals/rapport_plagiat.html' %}
{% include 'memoires/modals/confirmer_final.html' %}

<style>
.timeline-progress {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    margin: 30px 0;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
}

.step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 10px;
    border: 3px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.progress-step.completed .step-icon {
    background-color: var(--uom-blue);
    color: white;
}

.progress-step.active .step-icon {
    background-color: var(--uom-yellow);
    color: var(--uom-blue);
    animation: pulse 2s infinite;
}

.step-label {
    font-size: 0.85rem;
    text-align: center;
    color: #6c757d;
}

.progress-step.completed .step-label {
    color: var(--uom-blue);
    font-weight: 600;
}

.progress-line {
    flex: 1;
    height: 3px;
    background-color: #e9ecef;
    position: relative;
    top: -20px;
}

.progress-line.completed {
    background-color: var(--uom-blue);
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.action-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .timeline-progress {
        flex-direction: column;
    }
    
    .progress-line {
        width: 3px;
        height: 40px;
        top: 0;
    }
}
</style>
{% endblock %}



