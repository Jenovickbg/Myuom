{% extends 'users/base.html' %}
{% load static %}

{% block title %}Gestion des Enseignants - MyUOM{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0" style="color: var(--uom-blue);">Gestion des Enseignants</h2>
    <div>
      <a href="{% url 'admin_teacher_create' %}" class="btn btn-uom-primary"><i class="bi bi-person-plus"></i> Créer</a>
    </div>
  </div>

  <form method="get" class="mb-3">
    <div class="row g-3">
      <div class="col-md-6">
        <input type="text" name="search" class="form-control" placeholder="Rechercher (matricule, nom, email)" value="{{ search_query }}">
      </div>
      <div class="col-md-4">
        <select name="faculte" class="form-select">
          {% for value, label in faculte_choices %}
          <option value="{{ value }}" {% if faculte_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-uom-primary w-100" type="submit"><i class="bi bi-search"></i> Filtrer</button>
      </div>
    </div>
  </form>

  <div class="card card-uom">
    <div class="card-body">
      {% if teachers %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th><a href="?order=matricule{% if search_query %}&search={{ search_query }}{% endif %}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}" class="text-decoration-none">Matricule</a></th>
              <th><a href="?order=name{% if search_query %}&search={{ search_query }}{% endif %}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}" class="text-decoration-none">Nom</a></th>
              <th>Email</th>
              <th><a href="?order=faculte{% if search_query %}&search={{ search_query }}{% endif %}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}" class="text-decoration-none">Faculté</a></th>
              <th>Département</th>
              <th>Actif</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for t in teachers %}
            <tr>
              <td><span class="badge badge-uom-primary">{{ t.matricule }}</span></td>
              <td>{{ t.get_full_name|default:t.username }}</td>
              <td>{{ t.email|default:'—' }}</td>
              <td>
                {% if t.teacher_profile.faculte %}
                  <span class="badge bg-info">{{ t.teacher_profile.faculte.nom }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>{{ t.teacher_profile.department|default:'—' }}</td>
              <td>{% if t.is_active %}<span class="badge bg-success">Oui</span>{% else %}<span class="badge bg-secondary">Non</span>{% endif %}</td>
              <td class="text-end">
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewTeacherModal" data-teacher-id="{{ t.id }}" data-teacher-matricule="{{ t.matricule }}" data-teacher-name="{{ t.get_full_name }}" title="Voir détails"><i class="bi bi-eye"></i></button>
                <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#editTeacherModal" data-teacher-id="{{ t.id }}" data-teacher-matricule="{{ t.matricule }}" data-teacher-name="{{ t.get_full_name }}" title="Modifier"><i class="bi bi-pencil"></i></button>
                <a href="{% url 'admin_teacher_toggle_active' t.id %}" class="btn btn-outline-secondary btn-sm" title="Activer/Désactiver"><i class="bi bi-power"></i></a>
                <a href="{% url 'admin_teacher_reset_password' t.id %}" class="btn btn-outline-warning btn-sm" title="Réinitialiser mot de passe"><i class="bi bi-key"></i></a>
                <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteTeacherModal" data-teacher-id="{{ t.id }}" data-teacher-matricule="{{ t.matricule }}" data-teacher-name="{{ t.get_full_name }}" title="Supprimer"><i class="bi bi-trash"></i></button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <nav aria-label="Pagination" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if teachers.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ teachers.previous_page_number }}&order={{ order }}&search={{ search_query }}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}">Précédent</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Précédent</span></li>
          {% endif %}

          <li class="page-item disabled"><span class="page-link">Page {{ teachers.number }} / {{ teachers.paginator.num_pages }}</span></li>

          {% if teachers.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ teachers.next_page_number }}&order={{ order }}&search={{ search_query }}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}">Suivant</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Suivant</span></li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
        <p class="text-center text-uom-gray mb-0">Aucun enseignant trouvé.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de visualisation des détails d'enseignant -->
<div class="modal fade" id="viewTeacherModal" tabindex="-1" aria-labelledby="viewTeacherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewTeacherModalLabel">Détails de l'enseignant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <div id="teacher_photo" class="mb-3">
              <img src="/static/images/default-avatar.png" alt="Photo de profil" class="rounded-circle" width="100" height="100" style="object-fit: cover;">
            </div>
            <h5 id="teacher_full_name" class="mb-1"></h5>
            <span class="badge badge-uom-primary" id="teacher_matricule"></span>
          </div>
          <div class="col-md-8">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Identifiant</label>
                <p id="teacher_username" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Email</label>
                <p id="teacher_email" class="mb-0"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Date de naissance</label>
                <p id="teacher_birth_date" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Lieu de naissance</label>
                <p id="teacher_birth_place" class="mb-0"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Téléphone</label>
                <p id="teacher_phone" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Statut</label>
                <p id="teacher_status" class="mb-0"></p>
              </div>
            </div>
            <hr>
            <h6 class="text-uom-blue mb-3">Informations professionnelles</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Département</label>
                <p id="teacher_department" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Spécialité</label>
                <p id="teacher_speciality" class="mb-0"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Bureau</label>
                <p id="teacher_office" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Faculté</label>
                <p id="teacher_faculte" class="mb-0"></p>
              </div>
            </div>
            <hr>
            <h6 class="text-uom-blue mb-3">Informations système</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Date d'inscription</label>
                <p id="teacher_created_at" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Dernière connexion</label>
                <p id="teacher_last_login" class="mb-0"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-uom-primary" onclick="editTeacherFromView()">Modifier</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de modification d'enseignant -->
<div class="modal fade" id="editTeacherModal" tabindex="-1" aria-labelledby="editTeacherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTeacherModalLabel">Modifier l'enseignant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editTeacherForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Matricule</label>
              <input type="text" class="form-control" name="matricule" id="edit_matricule" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Identifiant</label>
              <input type="text" class="form-control" name="username" id="edit_username">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Prénom</label>
              <input type="text" class="form-control" name="first_name" id="edit_first_name">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Nom</label>
              <input type="text" class="form-control" name="last_name" id="edit_last_name">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" id="edit_email">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Département</label>
              <input type="text" class="form-control" name="department" id="edit_department">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Spécialité</label>
              <input type="text" class="form-control" name="speciality" id="edit_speciality">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Bureau</label>
              <input type="text" class="form-control" name="office" id="edit_office">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Faculté</label>
              <select class="form-control" name="faculte" id="edit_faculte">
                <option value="">-- Sélectionner --</option>
                {% for f in faculte_choices %}
                  {% if f.0 %}
                    <option value="{{ f.0 }}">{{ f.1 }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-uom-primary">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de suppression d'enseignant -->
<div class="modal fade" id="deleteTeacherModal" tabindex="-1" aria-labelledby="deleteTeacherModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTeacherModalLabel">Supprimer l'enseignant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer l'enseignant <strong id="delete_teacher_name"></strong> ?</p>
        <p class="text-danger"><strong>Cette action est irréversible !</strong></p>
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>Attention :</strong> Toutes les données associées à cet enseignant seront également supprimées.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form id="deleteTeacherForm" method="post" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Supprimer définitivement</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Gestion de la modal de visualisation
document.getElementById('viewTeacherModal').addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var teacherId = button.getAttribute('data-teacher-id');
  var teacherMatricule = button.getAttribute('data-teacher-matricule');
  var teacherName = button.getAttribute('data-teacher-name');
  
  // Afficher les informations de base
  document.getElementById('teacher_full_name').textContent = teacherName;
  document.getElementById('teacher_matricule').textContent = teacherMatricule;
  
  // Charger les données complètes de l'enseignant via AJAX
  fetch('/admin/teachers/' + teacherId + '/data/')
    .then(response => response.json())
    .then(data => {
      // Informations personnelles
      document.getElementById('teacher_username').textContent = data.username || '—';
      document.getElementById('teacher_email').textContent = data.email || '—';
      document.getElementById('teacher_birth_date').textContent = data.birth_date || '—';
      document.getElementById('teacher_birth_place').textContent = data.birth_place || '—';
      document.getElementById('teacher_phone').textContent = data.phone || '—';
      document.getElementById('teacher_status').innerHTML = data.is_active ? '<span class="badge bg-success">Actif</span>' : '<span class="badge bg-secondary">Inactif</span>';
      
      // Informations professionnelles
      document.getElementById('teacher_department').textContent = data.department || '—';
      document.getElementById('teacher_speciality').textContent = data.speciality || '—';
      document.getElementById('teacher_office').textContent = data.office || '—';
      document.getElementById('teacher_faculte').textContent = data.faculte_name || '—';
      
      // Informations système
      document.getElementById('teacher_created_at').textContent = data.created_at || '—';
      document.getElementById('teacher_last_login').textContent = data.last_login || 'Jamais';
    })
    .catch(error => console.error('Erreur:', error));
});

// Gestion de la modal d'édition
document.getElementById('editTeacherModal').addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var teacherId = button.getAttribute('data-teacher-id');
  var teacherMatricule = button.getAttribute('data-teacher-matricule');
  var teacherName = button.getAttribute('data-teacher-name');
  
  // Mettre à jour le formulaire
  document.getElementById('editTeacherForm').action = '/admin/teachers/' + teacherId + '/edit/';
  document.getElementById('edit_matricule').value = teacherMatricule;
  
  // Charger les données de l'enseignant via AJAX
  fetch('/admin/teachers/' + teacherId + '/data/')
    .then(response => response.json())
    .then(data => {
      document.getElementById('edit_username').value = data.username || '';
      document.getElementById('edit_first_name').value = data.first_name || '';
      document.getElementById('edit_last_name').value = data.last_name || '';
      document.getElementById('edit_email').value = data.email || '';
      document.getElementById('edit_department').value = data.department || '';
      document.getElementById('edit_speciality').value = data.speciality || '';
      document.getElementById('edit_office').value = data.office || '';
      document.getElementById('edit_faculte').value = data.faculte || '';
    })
    .catch(error => console.error('Erreur:', error));
});

// Gestion de la modal de suppression
document.getElementById('deleteTeacherModal').addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var teacherId = button.getAttribute('data-teacher-id');
  var teacherName = button.getAttribute('data-teacher-name');
  
  document.getElementById('deleteTeacherForm').action = '/admin/teachers/' + teacherId + '/delete/';
  document.getElementById('delete_teacher_name').textContent = teacherName;
});

// Fonction pour passer de la modal de visualisation à celle d'édition
function editTeacherFromView() {
  // Fermer la modal de visualisation
  var viewModal = bootstrap.Modal.getInstance(document.getElementById('viewTeacherModal'));
  viewModal.hide();
  
  // Ouvrir la modal d'édition
  setTimeout(function() {
    var editModal = new bootstrap.Modal(document.getElementById('editTeacherModal'));
    editModal.show();
  }, 300);
}
</script>
{% endblock %}