{% extends 'users/base.html' %}

{% block title %}Étudiants - Administration{% endblock %}

{# Les liens de navigation sont déjà définis dans le template de base #}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 style="color: var(--uom-blue);"><i class="bi bi-people"></i> Étudiants</h3>
  <div class="d-flex gap-2">
    <a href="{% url 'admin_student_bulk_import' %}" class="btn btn-uom-secondary"><i class="bi bi-file-earmark-arrow-up"></i> Import CSV</a>
    <a href="{% url 'admin_student_create' %}" class="btn btn-uom-primary"><i class="bi bi-person-plus"></i> Créer</a>
  </div>
</div>

<form method="get" class="mb-3">
  <div class="row g-3">
    <div class="col-md-4">
      <input type="text" name="search" class="form-control" placeholder="Rechercher (matricule, nom, email)" value="{{ search_query }}">
    </div>
    <div class="col-md-3">
      <select name="faculte" class="form-select">
        {% for value, label in faculte_choices %}
        <option value="{{ value }}" {% if faculte_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="promotion" class="form-select">
        {% for value, label in promotion_choices %}
        <option value="{{ value }}" {% if promotion_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-uom-primary w-100" type="submit"><i class="bi bi-search"></i> Filtrer</button>
    </div>
  </div>
</form>

<div class="card card-uom">
  <div class="card-body">
    {% if students %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th><a href="?order=matricule{% if search_query %}&search={{ search_query }}{% endif %}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}{% if promotion_filter %}&promotion={{ promotion_filter }}{% endif %}" class="text-decoration-none">Matricule</a></th>
            <th><a href="?order=name{% if search_query %}&search={{ search_query }}{% endif %}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}{% if promotion_filter %}&promotion={{ promotion_filter }}{% endif %}" class="text-decoration-none">Nom</a></th>
            <th>Email</th>
            <th><a href="?order=faculte{% if search_query %}&search={{ search_query }}{% endif %}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}{% if promotion_filter %}&promotion={{ promotion_filter }}{% endif %}" class="text-decoration-none">Faculté</a></th>
            <th><a href="?order=promotion{% if search_query %}&search={{ search_query }}{% endif %}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}{% if promotion_filter %}&promotion={{ promotion_filter }}{% endif %}" class="text-decoration-none">Promotion</a></th>
            <th>Actif</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td><span class="badge badge-uom-primary">{{ s.matricule }}</span></td>
            <td>{{ s.get_full_name|default:s.username }}</td>
            <td>{{ s.email|default:'—' }}</td>
            <td>
              {% if s.student_profile.faculte %}
                <span class="badge bg-info">{{ s.student_profile.faculte.nom }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if s.student_profile.promotion %}
                <span class="badge bg-secondary">{{ s.student_profile.promotion.nom_complet }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>{% if s.is_active %}<span class="badge bg-success">Oui</span>{% else %}<span class="badge bg-secondary">Non</span>{% endif %}</td>
            <td class="text-end">
              <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewStudentModal" data-student-id="{{ s.id }}" data-student-matricule="{{ s.matricule }}" data-student-name="{{ s.get_full_name }}" title="Voir détails"><i class="bi bi-eye"></i></button>
              <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#editStudentModal" data-student-id="{{ s.id }}" data-student-matricule="{{ s.matricule }}" data-student-name="{{ s.get_full_name }}" title="Modifier"><i class="bi bi-pencil"></i></button>
              <a href="{% url 'admin_student_toggle_active' s.id %}" class="btn btn-outline-secondary btn-sm" title="Activer/Désactiver"><i class="bi bi-power"></i></a>
              <a href="{% url 'admin_student_reset_password' s.id %}" class="btn btn-outline-warning btn-sm" title="Réinitialiser mot de passe"><i class="bi bi-key"></i></a>
              <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteStudentModal" data-student-id="{{ s.id }}" data-student-matricule="{{ s.matricule }}" data-student-name="{{ s.get_full_name }}" title="Supprimer"><i class="bi bi-trash"></i></button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    <nav aria-label="Pagination" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if students.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ students.previous_page_number }}&order={{ order }}&search={{ search_query }}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}{% if promotion_filter %}&promotion={{ promotion_filter }}{% endif %}">Précédent</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Précédent</span></li>
        {% endif %}

        <li class="page-item disabled"><span class="page-link">Page {{ students.number }} / {{ students.paginator.num_pages }}</span></li>

        {% if students.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ students.next_page_number }}&order={{ order }}&search={{ search_query }}{% if faculte_filter %}&faculte={{ faculte_filter }}{% endif %}{% if promotion_filter %}&promotion={{ promotion_filter }}{% endif %}">Suivant</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Suivant</span></li>
        {% endif %}
      </ul>
    </nav>
    {% else %}
      <p class="text-center text-uom-gray mb-0">Aucun étudiant trouvé.</p>
    {% endif %}
  </div>
</div>

<!-- Modal de visualisation des détails d'étudiant -->
<div class="modal fade" id="viewStudentModal" tabindex="-1" aria-labelledby="viewStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewStudentModalLabel">Détails de l'étudiant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <div id="student_photo" class="mb-3">
              <img src="/static/images/default-avatar.png" alt="Photo de profil" class="rounded-circle" width="100" height="100" style="object-fit: cover;">
            </div>
            <h5 id="student_full_name" class="mb-1"></h5>
            <span class="badge badge-uom-primary" id="student_matricule"></span>
          </div>
          <div class="col-md-8">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Identifiant</label>
                <p id="student_username" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Email</label>
                <p id="student_email" class="mb-0"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Date de naissance</label>
                <p id="student_birth_date" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Lieu de naissance</label>
                <p id="student_birth_place" class="mb-0"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Téléphone</label>
                <p id="student_phone" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Statut</label>
                <p id="student_status" class="mb-0"></p>
              </div>
            </div>
            <hr>
            <h6 class="text-uom-blue mb-3">Informations académiques</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Niveau</label>
                <p id="student_niveau" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Filière</label>
                <p id="student_filiere" class="mb-0"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Faculté</label>
                <p id="student_faculte" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Promotion</label>
                <p id="student_promotion" class="mb-0"></p>
              </div>
            </div>
            <hr>
            <h6 class="text-uom-blue mb-3">Contact d'urgence</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Nom du contact</label>
                <p id="student_emergency_contact" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Téléphone d'urgence</label>
                <p id="student_emergency_phone" class="mb-0"></p>
              </div>
            </div>
            <hr>
            <h6 class="text-uom-blue mb-3">Informations système</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Date d'inscription</label>
                <p id="student_created_at" class="mb-0"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Dernière connexion</label>
                <p id="student_last_login" class="mb-0"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-uom-primary" onclick="editStudentFromView()">Modifier</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de modification d'étudiant -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editStudentModalLabel">Modifier l'étudiant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editStudentForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Matricule</label>
              <input type="text" class="form-control" name="matricule" id="edit_matricule" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Identifiant</label>
              <input type="text" class="form-control" name="username" id="edit_username">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Prénom</label>
              <input type="text" class="form-control" name="first_name" id="edit_first_name">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Nom</label>
              <input type="text" class="form-control" name="last_name" id="edit_last_name">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" id="edit_email">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Niveau</label>
              <select class="form-control" name="niveau" id="edit_niveau">
                <option value="">-- Sélectionner --</option>
                <option value="L1">Licence 1</option>
                <option value="L2">Licence 2</option>
                <option value="L3">Licence 3</option>
                <option value="M1">Master 1</option>
                <option value="M2">Master 2</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Filière</label>
              <input type="text" class="form-control" name="filiere" id="edit_filiere">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Faculté</label>
              <select class="form-control" name="faculte" id="edit_faculte">
                <option value="">-- Sélectionner --</option>
                {% for f in faculte_choices %}
                  {% if f.0 %}
                    <option value="{{ f.0 }}">{{ f.1 }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Promotion</label>
              <select class="form-control" name="promotion" id="edit_promotion">
                <option value="">-- Sélectionner --</option>
                {% for p in promotion_choices %}
                  {% if p.0 %}
                    <option value="{{ p.0 }}">{{ p.1 }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-uom-primary">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de suppression d'étudiant -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1" aria-labelledby="deleteStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteStudentModalLabel">Supprimer l'étudiant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer l'étudiant <strong id="delete_student_name"></strong> ?</p>
        <p class="text-danger"><strong>Cette action est irréversible !</strong></p>
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>Attention :</strong> Toutes les données associées à cet étudiant seront également supprimées.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form id="deleteStudentForm" method="post" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Supprimer définitivement</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Gestion de la modal de visualisation
document.getElementById('viewStudentModal').addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var studentId = button.getAttribute('data-student-id');
  var studentMatricule = button.getAttribute('data-student-matricule');
  var studentName = button.getAttribute('data-student-name');
  
  // Afficher les informations de base
  document.getElementById('student_full_name').textContent = studentName;
  document.getElementById('student_matricule').textContent = studentMatricule;
  
  // Charger les données complètes de l'étudiant via AJAX
  fetch('/admin/students/' + studentId + '/data/')
    .then(response => response.json())
    .then(data => {
      // Informations personnelles
      document.getElementById('student_username').textContent = data.username || '—';
      document.getElementById('student_email').textContent = data.email || '—';
      document.getElementById('student_birth_date').textContent = data.birth_date || '—';
      document.getElementById('student_birth_place').textContent = data.birth_place || '—';
      document.getElementById('student_phone').textContent = data.phone || '—';
      document.getElementById('student_status').innerHTML = data.is_active ? '<span class="badge bg-success">Actif</span>' : '<span class="badge bg-secondary">Inactif</span>';
      
      // Informations académiques
      document.getElementById('student_niveau').textContent = data.niveau || '—';
      document.getElementById('student_filiere').textContent = data.filiere || '—';
      document.getElementById('student_faculte').textContent = data.faculte_name || '—';
      document.getElementById('student_promotion').textContent = data.promotion || '—';
      
      // Contact d'urgence
      document.getElementById('student_emergency_contact').textContent = data.emergency_contact || '—';
      document.getElementById('student_emergency_phone').textContent = data.emergency_phone || '—';
      
      // Informations système
      document.getElementById('student_created_at').textContent = data.created_at || '—';
      document.getElementById('student_last_login').textContent = data.last_login || 'Jamais';
      
      // Photo de profil
      if (data.photo) {
        document.getElementById('student_photo').innerHTML = '<img src="' + data.photo + '" alt="Photo de profil" class="rounded-circle" width="100" height="100" style="object-fit: cover;">';
      }
    })
    .catch(error => console.error('Erreur:', error));
});

// Gestion de la modal d'édition
document.getElementById('editStudentModal').addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var studentId = button.getAttribute('data-student-id');
  var studentMatricule = button.getAttribute('data-student-matricule');
  var studentName = button.getAttribute('data-student-name');
  
  // Mettre à jour le formulaire
  document.getElementById('editStudentForm').action = '/admin/students/' + studentId + '/edit/';
  document.getElementById('edit_matricule').value = studentMatricule;
  
  // Charger les données de l'étudiant via AJAX
  fetch('/admin/students/' + studentId + '/data/')
    .then(response => response.json())
    .then(data => {
      document.getElementById('edit_username').value = data.username || '';
      document.getElementById('edit_first_name').value = data.first_name || '';
      document.getElementById('edit_last_name').value = data.last_name || '';
      document.getElementById('edit_email').value = data.email || '';
      document.getElementById('edit_niveau').value = data.niveau || '';
      document.getElementById('edit_filiere').value = data.filiere || '';
      document.getElementById('edit_faculte').value = data.faculte || '';
      document.getElementById('edit_promotion').value = data.promotion || '';
    })
    .catch(error => console.error('Erreur:', error));
});

// Gestion de la modal de suppression
document.getElementById('deleteStudentModal').addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var studentId = button.getAttribute('data-student-id');
  var studentName = button.getAttribute('data-student-name');
  
  document.getElementById('deleteStudentForm').action = '/admin/students/' + studentId + '/delete/';
  document.getElementById('delete_student_name').textContent = studentName;
});

// Fonction pour passer de la modal de visualisation à celle d'édition
function editStudentFromView() {
  // Fermer la modal de visualisation
  var viewModal = bootstrap.Modal.getInstance(document.getElementById('viewStudentModal'));
  viewModal.hide();
  
  // Ouvrir la modal d'édition
  setTimeout(function() {
    var editModal = new bootstrap.Modal(document.getElementById('editStudentModal'));
    editModal.show();
  }, 300);
}
</script>
{% endblock %}
